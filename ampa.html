<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>Apple Maps Tile Downloader (Frontend + Cloudflare Worker)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <!-- Leaflet Draw JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <style>
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            display: flex;
            height: 100vh;
        }

        /* Â∑¶‰æßÈù¢Êùø */
        #sidebar {
            width: 320px;
            background: #f3f4f6;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #sidebar h2 {
            margin-top: 0;
            font-size: 20px;
        }

        #sidebar label {
            margin-top: 12px;
            font-size: 13px;
            font-weight: bold;
            display: block;
        }

        #sidebar input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        button {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background: #3a404d;
            border: none;
            color: white;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }

        button:hover {
            background: #2e2f30;
        }

        /* Âè≥‰æß‰∏ª‰Ωì */
        #content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 80vh;
        }


        #canvas-container {
            margin-top: 15px;
            padding: 10px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 300px;
            overflow: auto;
        }

        #canvas {
            max-width: 100%;
        }

        #errorBox {
            margin-top: 10px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            color: #302c2c;
            border: 1px solid #fca5a5;
            font-size: 12px;
            display: none;
        }
    </style>
</head>

<body>

    <div id="sidebar">
        <h2>üçé satellites.pro</h2>

        <label>STYLE</label>
        <input id="style" type="number" value="7">

        <label>SIZE</label>
        <input id="sizeParam" type="number" value="1">

        <label>SCALE</label>
        <input id="scale" type="number" value="1">

        <label>ZOOM</label>
        <input id="zoom" type="number" value="19">

        <label>VERSION</label>
        <input id="version" type="number" value="10311">

        <label>ACCESS_KEY</label>
        <input id="accessKey" placeholder="accessKey">


        <button onclick="startDownload()">Download</button>



        <!-- ‰∏ãËΩΩÁä∂ÊÄÅÊñáÊú¨ÔºàËøõÂ∫¶Ôºâ -->
        <p id="status"></p>

        <!-- Êñ∞Â¢ûÔºöÈîôËØØ‰ø°ÊÅØÊòæÁ§∫Âå∫ -->
        <div id="errorBox"></div>


        <div id="canvas-container">
            <canvas id="canvas"></canvas>
            <button onclick="exportPNG()">Import PNG</button>

        </div>
    </div>

    <p id="status"></p>
    </div>

    <div id="content">
        <div id="map"></div>
    </div>

    <script>

        // ÂàùÂßãÂåñÂú∞Âõæ
        const map = L.map('map').setView([53.364, -6.244], 17);
        L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        new L.Control.Draw({
            draw: { polygon: false, polyline: false, circle: false, marker: false, circlemarker: false },
            edit: { featureGroup: drawnItems }
        }).addTo(map);

        let bbox = null;

        map.on(L.Draw.Event.CREATED, function (ev) {
            drawnItems.clearLayers();
            drawnItems.addLayer(ev.layer);
            bbox = ev.layer.getBounds();
        });

        function lonLatToTile(lon, lat, zoom) {
            const x = (lon + 180) / 360 * Math.pow(2, zoom);
            const y = (
                1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI
            ) / 2 * Math.pow(2, zoom);
            return [Math.floor(x), Math.floor(y)];
        }

        async function startDownload() {

            document.getElementById("errorBox").style.display = "none";
            document.getElementById("errorBox").innerHTML = "";

          
            const accessKey = document.getElementById("accessKey").value.trim();
            
            
            const zoom = +document.getElementById("zoom").value;

            const style = +document.getElementById("style").value;
            const sizeParam = +document.getElementById("sizeParam").value;
            const scale = +document.getElementById("scale").value;
            const version = +document.getElementById("version").value;

            const status = document.getElementById("status");

            const south = bbox.getSouth();
            const north = bbox.getNorth();
            const west = bbox.getWest();
            const east = bbox.getEast();

            const [xMin, yMax] = lonLatToTile(west, south, zoom);
            const [xMax, yMin] = lonLatToTile(east, north, zoom);

            const totalX = xMax - xMin + 1;
            const totalY = yMax - yMin + 1;

            const TILE_SIZE = 256;
            const canvas = document.getElementById("canvas");
            canvas.width = totalX * TILE_SIZE;
            canvas.height = totalY * TILE_SIZE;
            const ctx = canvas.getContext("2d");

            let downloaded = 0;

            for (let x = xMin; x <= xMax; x++) {
                for (let y = yMin; y <= yMax; y++) {

                    const url =
                        "https://apple-proxy.yu-xia.workers.dev/" +
                        `?style=${style}&size=${sizeParam}&scale=${scale}` +
                        `&z=${zoom}&x=${x}&y=${y}` +
                        `&v=${version}&accessKey=${accessKey}`;

                    try {
                        const img = await loadImage(url);
                        ctx.drawImage(img, (x - xMin) * TILE_SIZE, (y - yMin) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    } catch (e) {
                        console.error("Tile loading failed", url);
                    }

                    downloaded++;
                    status.innerText = `DownloadingÔºö${downloaded} / ${totalX * totalY}`;
                }
            }


        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        function exportPNG() {
            const url = document.getElementById("canvas").toDataURL("image/png");
            const a = document.createElement("a");
            a.href = url;
            a.download = "apple_satellite.png";
            a.click();
        }

    </script>
</body>

</html>